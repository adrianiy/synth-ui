import { Meta, Story } from '@storybook/addon-docs';
import { WithGlobalTheme } from './../helpers/decorators';

<Story name="YAML" decorators={[ WithGlobalTheme ]} />

<Meta title="Composer/Configuration/YAML" />


###### Configuration
# YAML

These are all available properties to configure your **yaml** file.

##### Context
- [Name](?path=/docs/composer-yaml-name--page)
- [Variables](?path=/docs/composer-yaml-variables--page)

##### Basic
- [Pipe](?path=/docs/composer-yaml-pipe--page)
- [Log](?path=/docs/composer-yaml-pipe--page)
- [Filters](?path=/docs/composer-yaml-filters--page)
- [Custom](?path=/docs/composer-yaml-custom--page)

##### Async
- [Fetch](?path=/docs/composer-yaml-fetch--page)
- [Parallel](?path=/docs/composer-yaml-parallel--page)

##### Data processing
- [Group](?path=/docs/composer-yaml-group--page)
- [Join](?path=/docs/composer-yaml-join--page)
- [Transform](?path=/docs/composer-yaml-transform--page)
- [Sort](?path=/docs/composer-yaml-sort--page)
- [Filter](?path=/docs/composer-yaml-filter--page)


## Example

This is an example of a configuration file to get sales by country.

<div class="warning">

> We recommend to **organize everything under a pipe** middleware to ensure execution's order

</div>

```yaml
name: country sales
pipe:
  # add common pipe variables
  - variables:
        joinKeys:
            - cod_country

  # parse filters and store them in state
  - filters:
        current: true
        comparable: true
        a2: true

  # get data
  - parallel:
      - pipe:
          - fetch:
                url: v1/entities/country
                store: country
                filters: filters
                useFilters: 
                  - cod_brand
          - transform:
                data: country
                match: iso_code2
                transform:
                    key: () => 'cod_country'

    - fetch:
          url: v3/sales/orders/country
          multi:
              - filters: orderFilters
                store: current
              - filters: comparableOrderFilters
                store: comparable
              - filters: a2ComparableOrderFilters
                store: a2_comp

    - fetch:
          url: v4/sales/units/country
          multi:
                - filters: filters
                  store: current
                - filters: comparableFilters
                  store: comparable
                - filters: a2ComparableFilters
                  store: a2_comp

  # aggregate data
  - parallel:
      - group:
            data: current
      - group:
            data: comparable 
      - group:
            data: a2_comp

  # add suffixes
  - parallel:
      - transform:
          data: comparable
          match: units|amount|orders
          transform:
              key: key => `${key}_comp`
      - transform:
          data: a2_comp
          match: units|amount|orders
          transform:
              key: key => `${key}_comp_a2`

  # join data
  - join:
        data: comparable
        with: a2_comp

  - join:
        data: current
        with: comparable
        store: data


  # post-process data
  - sort:
        function: sortCountries
  - transform:
        match: cod_country
        transform:
            key: () => 'name'
            value: setCountryName
  - filter:
        required:
            - name
  - group:
        total: true

  # add growth fields
  - parallel:
      - transform:
            match: units|amount|orders
            exclude: comp|a2
            preserve: true
            transform:
                key: key => `growth_${key}`
                value: setGrowth
      - transform:
            match: units.*comp|amount.*comp|orders.*comp
            preserve: true
            transform:
                key: key => `growth_${key}_a2`
                value: setA2Growth
```
