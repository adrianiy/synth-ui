import { Meta, Story } from '@storybook/addon-docs/blocks';
import { WithGlobalTheme } from '../helpers/decorators';

<Story name="Filters" decorators={[ WithGlobalTheme ]} />

<Meta
    title="Providers/Filters"
/>

# Filters Prvider
##### FilterProvider

A provider to allow use of filters state across your application.

This will keep an state of which filters are applied and which are not. Will also apply
some logic on selection like filter relations management *Section -> Product line*.

<Story name="Filter Provider" />


```typescript
// main.tsx

import { FilterStateProvider } from 'glyph-react-poc';

...
    <FilterStateProvider>
        <Home/>
    </FilterStateProvider>
...
```

## Initial filters configuration

Filters initialization must be done with an initial configuration specifying application filters


```typescript
// filtersConfig.tsx

export const dateRanges = [
    { description: "Day +1", startDate: tomorrow, endDate: tomorrow },
    { description: "Real time", startDate: new Date(), endDate: new Date(), isDefault: true },
    { description: "Yesterday", startDate: yesterday, endDate: yesterday },
    { description: "Last 7 days", startDate: DateTime.local().minus({ days: 7 }).toJSDate(), endDate: yesterday },
    { description: "Last 14 days", startDate: DateTime.local().minus({ days: 14 }).toJSDate(), endDate: yesterday },
    {
        description: "Current fiscal year",
        startDate: new Date(year, 1, 1),
        endDate: tomorrow,
        comparableType: ComparableType.calendar,
    },
    {
        description: "Last fiscal year",
        startDate: new Date(year - 1, 1, 1),
        endDate: new Date(year, 0, 31),
        comparableType: ComparableType.calendar,
    },
];
export const FiltersConfig = {
    date: {
        description: dateRanges[1].description,
        minDate: new Date(year - 1, 1, 1),
        maxDate: tomorrow,
        key: "date",
        visible: true,
        dateRanges,
        startDate: dateRanges[1].startDate,
        endDate: dateRanges[1].endDate,
        comparableStartDate: null,
        comparableEndDate: null,
        version: "0.0.1",
        comparableType: ComparableType.commercial,
    },
    product: {
        description: "Producto",
        plural: "Productos",
        key: "cod_product",
        visible: true,
        multiSelect: true,
        options: [],
    },
    section: {
        description: "Sección",
        plural: "Secciones",
        key: "cod_section",
        visible: true,
        options: [],
    },
    campaign: {
        description: "Campaña",
        plural: "Campañas",
        key: "cod_campaign",
        visible: true,
        options: [],
    },
    market: {
        description: "Mercado",
        plural: "Mercados",
        key: "cod_market",
        related: ["platform"],
        searchPlaceholder: "filters.search.market",
        visible: true,
        options: [],
    },
    platform: {
        description: "País",
        plural: "Paises",
        key: "cod_platform",
        searchPlaceholder: "filters.search.platform",
        visible: true,
        options: [],
    },
};
```

## Filter initialization

```typescript
actions.filters.initialize(filterEntities, screen, baseFiltersConfig, initialFilters)
```

Filters can be initialized with some data from an entities request.

This data will be used to update filter options.

Filter options must mutch this interface

```typescript
interface FilterOption {
    code: any;
    description: string;
    display: boolean;
    header?: boolean;
    parents?: { [key]: any };
    children?: FilterOption[];
}
```

for more info -> [GIT](https://github.com/adrianiy/glyph-ui/blob/a900fc6e351ee341d97eb5a3b4ee78fcb2006c19/packages/glyph-core/src/models/filters.ts#L22)

You can use **GLYPH PIPES** to get filter entities data! take a look at the [DOCS](adrianiy.github.io/glyph-ui/core/index.html?path=/docs/glyph-pipes-common-filters--filters)

> **comming soon:** glyph-core will export a middleware that recovers data from WSC, and you will not need to care about GLYPH PIPES if you don't want to

```typescript
// home.tsx
...

import { useDispatch } from "react-redux";
import { useServices } from "@/providers";
import { actions } from "glyph-react";
import { FiltersConfig } from "../../utils/filters-config";

const Home = () => {
    const { entities } = useServices();
    const dispatch = useDispatch();

    useEffect(() => {
        async function loadFilters() {
            dispatch(
                actions.filters.initialize(
                    await entities.fetchFilterEntities([{ key: "cod_brand", op: "in", value: [1, 16] }]),
                    "konnect",
                    FiltersConfig,
                    {},
                ),
            );
        }
        loadFilters();
    }, [dispatch, entities]);

    return (
        ...
    );
};

export default Home;
```

We share a

# Custom hooks

<Story name="Custom hooks" />

We provide you with a set of custom hooks to use and modify filters state.

#### useFiltersConfig

This hook will return an object with these properties:

- **filtersConfig**: Object with latest filters configuration.
- **selectFilter**: Method to apply filter selection.
- **udpateFilter**: Method to apply filter update.
- **clearFitler**: Method to clear a filter by code.
- **clearAll**: Method to clear all filters.

```typescript
    import { useFiltersConfig } from 'glyph-react-poc';

    ....
    const { filtersConfig, selectFilter } = useFiltersConfig();
    ....
```

#### useFilters

This hook will return an object with these properties:

- **queryFilters**: Array with latest selected filters in format [ { key, op, value },... ]
- **queryParams**: Object of applied filters to use as query parameters  { startDate: ..., endDate: ..., product: .... }
- **compDates**: Array of comparable dates
- **comparableType**: comparable type of [ commercial, calendar, custom, ordinal ];

```typescript
    import { useFilters } from 'glyph-react-poc';

    ....
    const { queryFilters, comparableType } = useFilters();
    ....
```

### Logic inheritance

All logic implementation will lay on *glyph-core* vanilla javascript functions.


